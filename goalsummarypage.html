<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/goalsummarystyle.css">
    <link rel="stylesheet" href="css/global.css">
    <script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <script src="scripts/app.js"> var db=firebase.firestore();</script>
    <script src="scripts/loginverification.js"></script>
</head>
<body>
    <nav class=navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar style="background-color: #63E2E2; height:7.12%">
        <a class="nav-item nav-link active" id="home" href="main.html">Home</a>
        <a class="nav-item nav-link" id=journals href="journals.html">Journals</a>
        <a class="nav-item nav-link" id="goals" href="goals.html">Goals</a>
        <a class="nav-item nav-link" id="logoutbutton" href="index.html">Log Out</a>
    </nav>
    
    <h2 id="goalTitle" class="pageHeader"></h2>
    <h3 id="goalDescription" class="text"></h3>


    <div class="container">
      <a href="main.html"><button id="backbutton">Back</button></a>
    </div>

    <form id="goalSummary">
        <input type="submit" id="submitButton">
    </form>

<script>
    var query = decodeURI(window.location.search);
    var queries = query.split("?");
    var goalID = queries[1];
    let subGoalCollection = db.collection("Users").doc(user).collection("Goals").doc(goalID).collection("Subgoals").get();
    let goalDoc = db.collection("Users").doc(user).collection("Goals").doc(goalID);
    let goalDescription = ""
    let complete = 0;
    //Add goal name to page header
    document.getElementById("goalTitle").innerHTML = goalID;

    //Get goal description
    goalDoc.get().then(function(doc){if (doc.exists){goalDescription = doc.data()["description"];}})
    console.log(goalDescription);
    document.getElementById("goalDescription").innerHTML = goalDescription;

    function createListElements(doc) {

        //create bootstrap div element and append it to list
        let div = document.createElement("div");
        div.className ="checkbox";
        

        //create bootstrap label element and append to div
        let label = document.createElement("label");
        label.className="subgoalLabel";
        label.innerHTML= doc.data().name + "   ";
        div.appendChild(label);


        //create bootstrap input elements and append to div
        let input = document.createElement("input");
        
        input.type="checkbox";
        input.value = "";
        input.setAttribute("class", "subgoalCheckbox");
        if (doc.data().completed === true) {
            input.checked=true;
        }
        input.onclick= (function(){
            if (input.checked){
                complete++;
            }
            else{
                complete--;
            }
            db.collection("Users").doc(user).collection("Goals").doc(goalID).collection("Subgoals").doc(doc.id).update({
                completed: input.checked,
            }).then(function() {
                console.log("update")
            })

        })
        input.id = doc.data().name;
        div.appendChild(input);
        div.appendChild(label);

        document.getElementById("goalSummary").appendChild(div);

    }
    let total = 0;
    subGoalCollection.then(function (querySnapshot){
        querySnapshot.forEach(function(doc) {
            if (doc.data().name !== "") {
                total ++;
                createListElements(doc)
            }
        })
    })
    document.getElementById("goalSummary").addEventListener('submit', processForm);
    
    function processForm(e) {
        e.preventDefault()
        subGoalCollection.then(function (querySnapshot){
            querySnapshot.forEach(function(doc) {
                db.collection("Users").doc(user).collection("Goals").doc(goalID).update({
                    completePercentage: complete/total
                })
            })
        })
    }

</script>
<script src="scripts/logoutFunction.js"></script>
</body>
</html>