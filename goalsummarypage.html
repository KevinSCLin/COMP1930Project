<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Goal Summary</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/global.css">
    <script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <script src="scripts/app.js"></script>
    
</head>
<body>
    <nav class=navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar style="background-color: #63E2E2; height:7.12%">
        <a class="nav-item nav-link active" id="home" href="main.html">Home</a>
        <a class="nav-item nav-link" id=journals href="journals.html">Journals</a>
        <a class="nav-item nav-link" id="goals" href="goals.html">Goals</a>
        <a class="nav-item nav-link" id="logoutbutton" href="index.html">Log Out</a>
    </nav>
    
    <h2 id="goalTitle" class="pageHeader"></h2>
    <h3 id="goalDescription" class="text"></h3>

    <form id="goalSummary" class="container">
    </form>
    <script src="scripts/loginverification.js"></script>
<script>

    let query = decodeURI(window.location.search);
    let queries = query.split("?");
    let goalID = queries[1];
    let subGoalCollection = db.collection("Users").doc(user).collection("Goals").doc(goalID).collection("Subgoals").get();
    let goalDoc = db.collection("Users").doc(user).collection("Goals").doc(goalID);
    goalDoc.get().then(function(doc){
        document.getElementById("goalTitle").innerHTML = doc.data().name;
        document.getElementById("goalDescription").innerHTML = doc.data().description;
    })
    
    let buttonIndex=0;
    
    // //Add goal name to page header
    

    // //Get goal description
    // goalDoc.then(function(doc){
    
    // })
    

    function createListElements(doc) {

        //create bootstrap div element and append it to list
        let div = document.createElement("div");
        div.className ="checkbox";
        

        //create bootstrap label element and append to div
        let label = document.createElement("label");
        label.className="subgoalLabel";
        label.innerHTML= doc.data().name + "   ";
        div.appendChild(label);


        //create bootstrap input elements and append to div
        let input = document.createElement("input");
        input.type="checkbox";
        input.id = "input" + buttonIndex;
        buttonIndex++;
        input.value = "";
        input.className = "subgoalCheckbox";

        //Setting checked boxes to remain checked based on completion status
        if (doc.data().completed === true) {
            input.checked=true;
        }

        input.onclick= (function(){
            db.collection("Users").doc(user).collection("Goals").doc(goalID).collection("Subgoals").doc(doc.id).update({
                completed: input.checked,
            }).then(function() {
                console.log("update")
            })
        });
         
        //update database on subgoal status based on whether or nor checkbox is checked
            
        input.id = doc.data().name;
        div.appendChild(input);
        div.appendChild(label);

        document.getElementById("goalSummary").appendChild(div);
    }

    function updateTotals(){
        let total = 0;
        let completed = 0
        subGoalCollection.then(function(subgoals){
        subgoals.forEach(function(doc) {
            if (doc.data().name !== "") {
                if (doc.data().completed) {
                    completed ++;
                }
                total ++;
            }	            
        })
        goalDoc.update({
            totalSubgoals: total,
            completedSubgoals: completed,
        })
    });	    
    }
    function populateForm(){
        subGoalCollection.then(function (subgoals){
                subgoals.forEach(function (doc){
                    createListElements(doc);
                })
        }).then(function(){
            // add submit button to form
            addSubmitButton(document.getElementById("goalSummary"));
        
        })
    }
    populateForm()
       
    function addSubmitButton(elementToAddTo){
        let submit = document.createElement("input");
        submit.type= "submit";
        submit.className="buttons";
        submit.innerHTML = type;
        elementToAddTo.appendChild(submit)
    }
    function hideForm(){
        document.body.childNodes().forEach(function (element){
            element.display="none";
        })
    }
    
    // add event listener for submitting checkboxes
    document.getElementById("goalSummary").addEventListener('submit', processForm);


    //process form on submit
    function processForm(form) {
        updateTotals();
        form.preventDefault();
        goalDoc.get().then(function (doc){
            if (doc.data().completedSubgoals !== doc.data().totalSubgoals) {
                goalDoc.update({
                    completePercentage: Math.round(doc.data().completedSubgoals / doc.data().totalSubgoals * 100),
                })
            } else {
                goalDoc.update({
                    completePercentage: Math.round(doc.data().completedGoals / doc.data().totalSubgoals * 100),
                    complete: true,
                }).then(function(){
                    hideForm();
                    let message = document.createElement("div");
                    message.className="Goals";
                    message.innerHTML="Congratulations you have completed your goal";
                    document.body.appendChild(message);
                })
            }
        })  
    }
    // Go to Add Subgoal page
    function GoToAddSubGoal() {
        window.location.href = "add_more_subgoals.html?" + goalID;
    }

</script>
<script src="scripts/logoutFunction.js"></script>

<a href="main.html"><div class="buttons">Back</div></a>
<a href="add_more_subgoals.html?" + goalID;><div class="buttons">Add Subgoals</div></a>
</body>
</html>